# План рефакторинга ParFamily_script.py

## Обзор
Скрипт pyRevit для пакетного добавления общих параметров (Shared Parameters) в семейства Revit.
Текущая версия: v9, ~730 строк кода.

---

## Выявленные проблемы

### 1. Обработка ошибок
- **Голые `except:` блоки** — более 15 случаев `except: pass` скрывают ошибки
- Нет логирования в catch-блоках
- Непоследовательная обработка исключений в транзакциях

### 2. Дублирование кода
- Функция `_set_instance_default` (строки 148-229): повторяющийся паттерн для Length/Area/Volume/Angle
- Поиск `extdef` по GUID дублируется в `_run` и `_resolve_extdef_by_guid`
- Повторяющиеся проверки `ptype == X or ptype.ToString() == 'X'`

### 3. Импорты
- Wildcard импорт `from Autodesk.Revit.DB import *` — затрудняет понимание зависимостей
- Импорты внутри функций (`UnitType`, `UnitUtils` в строках 190, 199, 208, 217)

### 4. Структура и архитектура
- Весь код в одном файле (700+ строк)
- Класс `MainController` имеет слишком много обязанностей (UI + бизнес-логика)
- XAML встроен как строка в Python код (строки 334-442)

### 5. Именование и стиль
- Смешение стилей: `_private_func` и `publicFunc`
- Неинформативные имена: `d`, `g`, `dd`, `t1`, `t2`
- Однобуквенные переменные в циклах

### 6. Магические значения
- Захардкоженные строки UI на русском языке
- Повторяющиеся строки ошибок
- Нет констант для значений по умолчанию

### 7. Совместимость с Revit API
- Проверки `ptype.ToString()` как fallback указывают на проблемы между версиями Revit
- Нет явной обработки различий API между Revit 2020-2025

### 8. Потенциальные баги
- Строка 284: `t2.RollBack()` может упасть если `t2` не определена
- Использование `OpenFileDialog` для сохранения файла (строка 586) вместо `SaveFileDialog`
- Нет проверки на успешность `t1.Start()` перед операциями

---

## План исправлений

### Фаза 1: Критические исправления
- [x] Заменить `OpenFileDialog` на `SaveFileDialog` в `_save_queue`
- [x] Исправить потенциальный `NameError` для `t2` — добавлена инициализация `t2 = None`
- [x] Добавить проверки статуса транзакций — `t.HasStarted()` и `t.HasEnded()`
- [x] Исправить транзакцию в `_ensure_family_has_type` — добавлено логирование

### Фаза 2: Улучшение обработки ошибок
- [x] Создать helper-функции: `safe_rollback()`, `safe_call()`
- [x] Заменить все `except: pass` на явную обработку с логированием (~15 мест)
- [x] Добавить контекстные сообщения об ошибках
- [x] Использовать конкретные типы исключений где возможно (`ValueError`, `UnicodeDecodeError`)

### Фаза 3: Устранение дублирования
- [ ] Создать универсальную функцию для конвертации единиц измерения
- [ ] Вынести повторяющуюся логику поиска ExtDef в отдельный метод
- [ ] Создать helper для проверки типа параметра

### Фаза 4: Рефакторинг структуры
- [x] Вынести XAML в отдельный файл `.xaml` → `MainWindow.xaml`
- [ ] Разделить `MainController` на:
  - `UIController` — управление интерфейсом
  - `ParameterService` — логика работы с параметрами
  - `FamilyService` — логика работы с семействами
- [ ] Перенести утилиты в отдельный модуль

### Фаза 5: Улучшение читаемости
- [ ] Заменить wildcard импорт на явные импорты
- [ ] Переименовать переменные для ясности
- [ ] Добавить docstrings к функциям и классам
- [ ] Вынести строковые константы в начало файла

### Фаза 6: Совместимость с версиями Revit
- [ ] Создать модуль совместимости для обработки различий API
- [ ] Добавить проверку версии Revit в начале скрипта
- [ ] Унифицировать работу с единицами измерения для разных версий

---

## Приоритет выполнения

1. **Высокий**: Фаза 1 (критические баги)
2. **Высокий**: Фаза 2 (стабильность)
3. **Средний**: Фаза 3 (поддерживаемость)
4. **Средний**: Фаза 5 (читаемость)
5. **Низкий**: Фаза 4 (архитектура)
6. **Низкий**: Фаза 6 (совместимость)

---

## Примечания

- Скрипт работает с IronPython 2.7 — учитывать ограничения синтаксиса
- Поддержка Revit 2020-2025 — тестировать на разных версиях
- XAML UI требует .NET Framework — не переносить на PyQt/tkinter

# Ежедневный экспорт NWC

Скрипт для ежедневного экспорта моделей Revit в формат Navisworks (.nwc) с автоматической проверкой актуальности и запуском по расписанию через Windows Scheduled Task.

## Описание

Скрипт автоматизирует процесс ежедневного экспорта множества RVT-файлов в формат NWC для использования в Navisworks. Основная цель - получать актуальные NWC файлы каждый день автоматически, экспортируя только изменившиеся модели.

## Основные возможности

- **Три режима работы**:
  - Ручной экспорт (одноразовый)
  - Автозапуск через Windows Scheduled Task
  - Долгоживущая служба (Service) в __persistentengine__ с периодической проверкой
- **Ежедневный экспорт**: автоматический запуск в указанное время (по умолчанию 00:00)
- **Проверка актуальности**: сравнение дат изменения RVT и NWC файлов через os.path.getmtime
- **Умный экспорт**: экспортируются только изменившиеся модели
- **ExternalEvent**: безопасный вызов Revit API из фонового потока службы
- **Гибкая конфигурация**: настройка через txt файлы в папке Object
- **Логирование**: детальные логи в отдельные файлы по дням (хранение 7 дней)
- **Защита от повторного запуска**: lock-файл для предотвращения конфликта

## Зависимости

### Внутренние модули (lib/)
- `nwc_export_utils.py` - модуль экспорта NWC
- `openbg.py` - модуль фонового открытия RVT-файлов
- `closebg.py` - модуль безопасного закрытия документов

### Revit API
- `Autodesk.Revit.DB`: ModelPathUtils, View3D, NavisworksExportOptions, FilteredElementCollector

### pyRevit
- `script`, `coreutils`, `forms` - для UI, таймеров и диалогов
- `forms.SelectFromList` - выбор объектов
- `forms.pick_folder` - выбор папки
- `forms.ask_for_string` - настройка времени

## Архитектура

### Долгоживущая служба (Service Mode)

Служба использует следующий паттерн для безопасной работы с Revit API:

```python
class NWCExportHandler(IExternalEventHandler):
    """Handler для выполнения экспорта через ExternalEvent."""

    def Execute(self, app):
        """Выполняется в контексте Revit API."""
        # Вызываем export_rvt_to_nwc_full здесь
        # Это гарантирует, что Revit API вызывается из правильного потока

class ServiceManager:
    """Менеджер долгоживущей службы в __persistentengine__."""

    def _service_loop(self):
        """Основной цикл службы."""
        while self.running:
            # Проверяем актуальность для всех объектов
            # Если нужен экспорт → вызываем ExternalEvent.Raise()
            # Ждём завершения через Event.wait()
            time.sleep(SERVICE_INTERVAL_SECONDS)

    def get_status(self):
        """Возвращает статус службы для UI (running, last_error, last_error_time)."""
```

**Важные особенности:**

1. **__persistentengine__**: служба сохраняется между запусками кнопки
2. **ExternalEvent**: безопасный вызов Revit API из фонового потока
3. **Daemon thread**: поток помечен как daemon, чтобы не блокировать закрытие Revit
4. **Lock**: защита от параллельных экспортов
5. **Event.wait()**: синхронизация между потоком службы и потоком Revit API

### Логика работы

```
1. Первичная настройка (ручной режим):
   - Выбор папки Object (сохраняется в Object_folder_path.txt)
   - Выбор объектов для экспорта (сохраняется в Ежедневная выгрузка.txt)
   - Настройка времени автозапуска (создаётся scheduled task)

2. Повторный запуск (ручной режим):
   - Читаются сохранённые настройки
   - Главное меню с опциями:
     * Экспортировать сейчас
     * Start Service / Stop Service (долгоживущая служба)
     * Настроить список объектов
     * Настроить папку Object
     * Настроить автозапуск (scheduled task)
     * Удалить автозапуск

3. Долгоживущая служба (Service):
   - Запускается через кнопку "Start Service"
   - Сохраняется в __persistentengine__ как атрибут daily_nwc_service
   - Работает в отдельном daemon-потоке
   - Каждые SERVICE_INTERVAL_SECONDS (300 сек = 5 мин) проверяет актуальность
   - Вызывает экспорт через ExternalEvent только при необходимости
   - Повторный запуск кнопки не создаёт второй таймер
   - "Stop Service" останавливает службу и очищает __persistentengine__

4. Автоматический запуск (scheduled task):
   - Запуск скрипта с флагом --auto
   - Читаются сохранённые настройки
   - Проверка актуальности и экспорт
   - Логирование в файл
   - Завершение без UI
```

### Проверка актуальности

```python
def check_need_export(rvt_path, nwc_folder, object_name):
    # Проверяем два варианта имени NWC:
    # 1. object_name.nwc (то же имя, что RVT)
    # 2. object_name с заменой _RXX на _NXX (например, Файл_R22 → Файл_N22)
    #
    # Если оба существуют → выбираем более новый
    # Если один существует → используем его
    # Если ни одного → нужно экспортировать

    # Сравниваем даты изменения
    rvt_mtime = os.path.getmtime(rvt_path)
    nwc_mtime = get_most_recent_nwc_mtime(nwc_folder, object_name)

    if rvt_mtime > nwc_mtime:
        return True, "RVT обновлён"

    return False, "NWC актуален"
```

**Пример:**
- RVT файл: `Файл_R22.rvt`
- NWC варианты: `Файл_R22.nwc` или `Файл_N22.nwc`
- Скрипт проверяет оба и использует более новый

### Scheduled Task

Скрипт создаёт Windows Scheduled Task для ежедневного запуска:

1. Создаётся bat-файл `run_daily_export.bat`:
```batch
@echo off
echo Starting daily NWC export at %date% %time%
C:\Users\Vladi\AppData\Roaming\pyRevit\Revit\addin\bin\pyrevit.exe run "WW.BIM.tab BIM.panel Экспорт.stack Ежедневный экспорт NWC.pushbutton" --auto --time 00:00
echo Export completed at %date% %time%
```

2. Создаётся scheduled task через `schtasks.exe`:
```batch
schtasks /create /tn "Ежедневный экспорт NWC" /tr "D:\Project\Object\run_daily_export.bat" /sc daily /st 00:00 /f
```

## Конфигурация

### Файловая структура данных (в проекте):

```
Проект/Object/
├── Здание1.txt                      # C:/Project/Здание1.rvt
├── Здание1_NWC.txt                  # D:/NWC/Здание1/
├── Здание2.txt                      # C:/Project/Здание2.rvt
├── Здание2_NWC.txt                  # D:/NWC/Здание2/
├── Здание3.txt                      # C:/Project/Здание3.rvt
├── Здание3_NWC.txt                  # D:/NWC/Здание3/
├── Ежедневная выгрузка.txt          # Здание1,Здание2 (список)
├── Object_folder_path.txt            # D:/Project/Object/ (путь к папке)
├── run_daily_export.bat             # bat-файл для автозапуска
├── logs/                            # папка для логов
│   └── export_log_2025-01-19.txt  # лог за день
└── .export_lock                     # lock-файл для защиты от повторного запуска
```

### Формат файлов конфигурации

#### `Объект.txt`:
```
C:/Project/Здание1.rvt
```

#### `Объект_NWC.txt`:
```
D:/NWC/Экспорт/Здание1/
```

#### `Ежедневная выгрузка.txt`:
```
Здание1
Здание2
Здание3
```

#### `Object_folder_path.txt`:
```
D:/Project/Object/
```

### Константы скрипта

- `OBJECT_FOLDER_CONFIG` = "Object_folder_path.txt"
- `DAILY_EXPORT_LIST` = "Ежедневная выгрузка.txt"
- `LOG_FOLDER` = "logs"
- `AUTO_MODE_FLAG` = "--auto"
- `LOCK_FILE` = ".export_lock"
- `TASK_NAME` = "Ежедневный экспорт NWC"
- `BAT_FILE` = "run_daily_export.bat"
- `LOG_RETENTION_DAYS` = 7
- `SERVICE_INTERVAL_SECONDS` = 300 (интервал проверки службы: 5 минут)
- `SERVICE_PERSISTENT_KEY` = "daily_nwc_service" (ключ в __persistentengine__)
- `EXPORT_ENABLED` = False (включение реального экспорта NWC; False = dry-run mode, только проверка актуальности)

## Оптимизации производительности

### 1. Проверка актуальности
- **Проблема**: экспортировать все модели каждый день → медленно
- **Решение**: сравнение дат RVT и NWC → экспорт только изменившихся

### 2. Фильтрация рабочих наборов
- Используется предикат из `openbg.py`
- Исключаются рабочие наборы: начинающиеся с `00_`, содержащие 'Link' или 'Связь'

### 3. Detached-режим
- Опция: `detach=True` → `DetachAndPreserveWorksets`
- Эффект: нет синхронизации с центральной моделью, быстрее открытие/закрытие

### 4. Автоматическое подавление предупреждений
- Используется `openbg.open_in_background()` с `suppress_dialogs=True`
- Автоматически закрываются диалоговые окна Revit

## Вывод информации

### Логирование в файл

Формат лог файла `export_log_YYYY-MM-DD.txt`:

```
========================================
Ежедневный экспорт NWC - 2025-01-19 00:00:00
========================================

[00:00:01] Объект: Здание1
[00:00:01]   - RVT: C:/Project/Здание1.rvt
[00:00:01]   - NWC: D:/NWC/Здание1/Здание1.nwc
[00:00:01]   - Причина: RVT обновлён
[00:00:05]   - Экспорт: УСПЕХ (время: 4s, размер: 45.2 MB)

[00:00:05] Объект: Здание2
[00:00:05]   - RVT: C:/Project/Здание2.rvt
[00:00:05]   - NWC: D:/NWC/Здание2/Здание2.nwc
[00:00:05]   - Причина: NWC актуален
[00:00:05]   - RVT дата: 2025-01-17 10:00:00
[00:00:05]   - NWC дата: 2025-01-18 00:00:01

[00:00:05] Объект: Здание3
[00:00:05]   - Ошибка: Файл RVT не найден

========================================
ИТОГО: Всего: 3, Экспортировано: 1, Пропущено: 1, Ошибок: 1
Время выполнения: 6s
========================================
```

### Вывод в PyRevit Output (ручной режим):

```
## ЭКСПОРТ NWC (2)
Папка экспорта: **D:/Project/Object**
___

:hourglass: Экспортирую: **Здание1**
:white_check_mark: Здание1: УСПЕХ (45.2 MB)

:hourglass: Экспортирую: **Здание2**
:white_check_mark: Здание2: NWC актуален

___
**Готово. Всего: 2, Экспортировано: 1, Пропущено: 1, Ошибок: 0**
**Время выполнения: 5s**
**Лог: `D:/Project/Object/logs/export_log_2025-01-19.txt`**
```

## Технические детали

### Защита от повторного запуска

Используется lock-файл `.export_lock` в папке Object:

1. При запуске скрипт проверяет наличие lock-файла
2. Если lock-файл существует:
   - Проверяем его возраст (если старше 24 часов → удаляем)
   - Если новый → выходим с сообщением "Скрипт уже выполняется"
3. При успешном запуске создаётся lock-файл с текущим временем
4. При завершении скрипта lock-файл удаляется

### Хранение логов

Логи хранятся в папке `logs` внутри папки Object:

- Название файла: `export_log_YYYY-MM-DD.txt`
- Хранение: 7 дней (старые логи удаляются автоматически)
- Режим записи: append (добавление в конец файла)

### Настройка времени экспорта

Для тестирования можно настроить любое время экспорта:

1. Ручной режим → "Настроить автозапуск"
2. Ввести время в формате ЧЧ:ММ (например, 14:30)
3. Scheduled task пересоздаётся на указанное время

## Совместимость

- **Revit**: 2020-2024
- **pyRevit**: требуется установленный pyRevit с поддержкой Revit API и __persistentengine__
- **Windows**: 7+ (для работы scheduled tasks)
- **Python 3.x**: threading, os, datetime, glob

## Ограничения службы

1. **Работает только пока Revit открыт**: при закрытии Revit служба прекращает работу
2. **Один экземпляр на сессию**: повторный запуск кнопки не создаёт второй таймер
3. **Daemon thread**: поток помечен как daemon, что позволяет Revit закрыться корректно
4. **Интервал проверки**: по умолчанию 5 минут (SERVICE_INTERVAL_SECONDS = 300)
5. **ExternalEvent таймаут**: по умолчанию 600 секунд (10 минут) на один экспорт
6. **Без UI из фонового потока**: все ошибки службы пишутся только в файл-лог, UI получает статус при остановке/запуске

## Устранение проблем

### Проблема: "Служба уже запущена"
**Решение**: Сначала выберите "Stop Service" перед повторным запуском

### Проблема: "Не настроена папка Object"

## Пример использования

### Первичная настройка:

1. Запустить скрипт в ручном режиме
2. Выбрать папку `Object`
3. Создать файлы конфигурации:
   - `Здание1.txt` → путь к RVT
   - `Здание1_NWC.txt` → папка для NWC
4. Выбрать объекты для ежедневной выгрузки
5. Настроить автозапуск на 00:00
6. Готово!

### Повторный запуск:

1. Нажать кнопку "Ежедневный экспорт NWC"
2. Выбрать опцию "Экспортировать сейчас"
3. Скрипт проверит актуальность и экспортирует изменившиеся модели

### Автоматический запуск:

1. Scheduled task запускает bat-файл в 00:00
2. Скрипт запускается с флагом `--auto`
3. Проверяется актуальность и выполняется экспорт
4. Результаты записываются в лог файл

### Запуск службы:

1. Нажать кнопку "Ежедневный экспорт NWC"
2. Выбрать опцию "Start Service"
3. Служба запускается в фоновом потоке
4. Каждые 5 минут проверяется актуальность всех объектов
5. При необходимости экспорт выполняется через ExternalEvent
6. Логи пишутся в файл logs/export_log_YYYY-MM-DD.txt
7. Выбрать "Stop Service" для остановки

## Новые классы и функции

### NWCExportHandler (IExternalEventHandler)

Обёртка для безопасного вызова Revit API из фонового потока службы.

- `set_export_request()`: устанавливает параметры для следующего экспорта
- `Execute(app)`: выполняется в контексте Revit API, вызывает export_rvt_to_nwc_full
- `export_event`: threading.Event для синхронизации завершения экспорта

### NWCExportTask

Менеджер для выполнения экспорта через ExternalEvent.

- `export()`: выполняет экспорт с заданным таймаутом (по умолчанию 600 сек)
- Возвращает результат экспорта или ошибку, если ExternalEvent не принят

### ServiceManager

Менеджер долгоживущей службы, сохраняемый в __persistentengine__.

- `start()`: запускает daemon-поток с циклом проверки
- `stop()`: останавливает службу
- `_service_loop()`: основной цикл, проверяет актуальность каждые N секунд
- `_check_and_export()`: проверяет все объекты на необходимость экспорта
- `_export_single()`: выполняет экспорт одного объекта через ExternalEvent
- `export_lock`: threading.Lock для защиты от параллельных экспортов

### Функции для работы с __persistentengine__

- `get_service_manager()`: получает экземпляр ServiceManager из persistent engine
- `set_service_manager()`: сохраняет экземпляр ServiceManager в persistent engine
- `clear_service_manager()`: удаляет экземпляр ServiceManager из persistent engine

## Полный запрет UI-операций из фонового потока

**Реализовано:**

- **Никаких `out.print_md()` из thread**: все ошибки службы пишутся только в файл-лог
- **Отслеживание ошибок**: `last_error` и `last_error_time` сохраняются в ServiceManager
- **Статус для UI**: метод `get_status()` возвращает состояние службы для UI
- **Вывод в UI**: только при запуске/остановке службы (из основного потока, не из daemon)

**Пример:**

```python
def _service_loop(self):
    """Основной цикл службы."""
    while self.running:
        try:
            self._check_and_export()
        except Exception as e:
            # Записываем в лог (файл, не UI)
            self.last_error = str(e)
            self.last_error_time = datetime.datetime.now()
            log_message(self.log_path, "[Service Error] {}".format(e))
        time.sleep(SERVICE_INTERVAL_SECONDS)

def get_status(self):
    """Получить статус службы для UI."""
    return {
        "running": self.running,
        "last_error": self.last_error,
        "last_error_time": self.last_error_time,
    }
```

## Сравнение режимов

### Ручной экспорт (Export Now)
- **Когда использовать**: одноразовый экспорт, тестирование
- **Преимущества**: немедленное выполнение, полный контроль
- **Недостатки**: нужно запускать вручную

### Scheduled Task (Auto Export)
- **Когда использовать**: ежедневный экспорт в фиксированное время
- **Преимущества**: работает даже при закрытом Revit (если настроен bat)
- **Недостатки**: требует Windows Scheduled Task, сложная отладка

### Служба (Service)
- **Когда использовать**: периодическая проверка в течение дня
- **Преимущества**:
  - Работает пока Revit открыт
  - Нет внешних зависимостей (нет bat/schtasks)
  - Легко отлаживать через pyRevit Output
  - Можно запустить/остановить в любой момент
- **Недостатки**: работает только пока Revit открыт

## Возможные улучшения

- [ ] Добавить поддержку экспорта в форматы NWD/NWF
- [ ] Добавить настройку списка скрываемых категорий через UI
- [ ] Поддержка экспорта по уровням/зонам
- [ ] Параллельный экспорт (если Revit API позволит)
- [ ] Экспорт сводки об ошибках в CSV/Excel
- [ ] Отправка уведомлений по email/Telegram при ошибках

## Устранение проблем

### Проблема: "Не настроена папка Object"
**Решение**: Запустите скрипт в ручном режиме и выберите папку Object через диалог

### Проблема: "Не настроен список объектов"
**Решение**: Создайте файлы `ИмяОбъекта.txt` и `ИмяОбъекта_NWC.txt` в папке Object, затем выберите объекты через UI

### Проблема: "Не найден pyrevit.exe"
**Решение**: Проверьте установку pyRevit. Стандартные пути:
- `C:\Users\<User>\AppData\Roaming\pyRevit\Revit\addin\bin\pyrevit.exe`
- `C:\Users\<User>\AppData\Local\pyRevit\bin\pyrevit.exe`

### Проблема: "Скрипт уже выполняется"
**Решение**: Если скрипт завис, удалите файл `.export_lock` в папке Object вручную

### Проблема: "Ошибка открытия: файл не найден"
**Решение**: Проверьте правильность путей в файлах `ИмяОбъекта.txt`

## Реализованные возможности

- [x] Ежедневный экспорт NWC с проверкой актуальности
- [x] Автоматический запуск через Windows Scheduled Task
- [x] Долгоживущая служба в __persistentengine__ с периодической проверкой
- [x] Вызов экспорта через ExternalEvent (безопасный Revit API вызов)
- [x] Защита от создания параллельных таймеров и экспортов
- [x] Сохранение состояния службы между запусками кнопки
- [x] Гибкая конфигурация через txt файлы
- [x] Детальное логирование в отдельные файлы
- [x] Защита от повторного запуска
- [x] Автоматическое удаление старых логов (7 дней)
- [x] Настройка времени экспорта для тестирования
- [x] Обработка ошибок с продолжением выполнения
- [x] Использование обработки ошибок из openbg.py

## Структура __persistentengine__

При запуске службы в `__persistentengine__` создаётся атрибут `daily_nwc_service`:

```python
__persistentengine__.daily_nwc_service = ServiceManager(...)
```

Этот экземпляр содержит:
- `object_folder_path`: путь к папке Object
- `export_list`: список объектов для экспорта
- `log_path`: путь к файлу лога
- `app`: экземпляр Revit.Application
- `revit`: экземпляр Revit
- `running`: флаг работы службы
- `thread`: daemon-поток с циклом проверки
- `export_task`: экземпляр NWCExportTask для ExternalEvent
- `export_lock`: threading.Lock для защиты от параллельных экспортов
- `last_error`: последняя ошибка службы (None если нет)
- `last_error_time`: время последней ошибки (None если нет)

При остановке службы:
1. `running = False` → цикл останавливается
2. `thread.join(timeout=5)` → ждём завершения потока
3. `clear_service_manager()` → удаляем атрибут из __persistentengine__

# Пересечения - Анализ XML-отчётов Navisworks

## Описание

Скрипт pyRevit для чтения и анализа XML-отчётов Navisworks о пересечениях элементов. Позволяет:

- Читать XML-отчёты Navisworks (включая "Все тесты...")
- Показывать все проверки, даже пустые (без коллизий)
- Фильтровать результаты по текущей модели Revit
- Отображать таблицы с подсветкой категорий элементов
- Выводить сводную статистику по коллизиям
- Показывать дату отчёта

## Структура кода

### Константы и настройки

```python
FILTER_BY_FILE = True       # Фильтр по файлу модели
FILTER_BY_CATEGORY = False  # Дополнительный фильтр по категории
OBJECT_ID_NAMES            # Имена атрибутов для поиска ID
DATE_ATTRIBUTES            # Атрибуты даты в XML
BADGE_STYLE                # CSS для подсветки категорий
```

### Основные классы

#### 1. `Patterns`
Хранит скомпилированные регулярные выражения для парсинга:
- `BAD_AMPERSAND` - исправление некорректных амперсандов в XML
- `MODEL_FILE` - поиск имён файлов моделей (.nwc, .nwd, .nwf, .rvt)
- `DATE_ATTR` - извлечение даты из XML
- Паттерны для fallback-парсера (regex)

#### 2. `ElementCache`
Кэш элементов Revit и работа с категориями.

**Методы:**
- `get_element_and_category(element_id)` - получить элемент и его категорию
- `matches_current_model(path_text)` - проверка, относится ли путь к текущей модели
- `find_category_in_path(segment_normalized)` - поиск категории в сегменте пути
- `normalize_key(text)` - нормализация строки для сравнения

**Внутренние данные:**
- `_cache` - кэш элементов {id: (element, category)}
- `_category_keys` - набор нормализованных имён категорий документа
- `_doc_title_key` - нормализованное имя документа

#### 3. `XmlReader`
Безопасное чтение XML-файлов.

**Методы:**
- `read_file(path)` - чтение с автоопределением кодировки (utf-8-sig, utf-16, utf-8, cp1251)
- `sanitize(text)` - очистка текста от некорректных символов
- `parse(xml_path)` - парсинг XML и возврат корневого элемента

**Обрабатывает:**
- Некорректную кодировку
- Недопустимые XML-символы
- Неэкранированные амперсанды
- BOM-маркеры

#### 4. `NavisworksReportParser`
Основной парсер XML-отчётов Navisworks.

**Методы:**
- `parse()` - главный метод, возвращает `dict: test_name -> [rows]`
- `_parse_with_xml_parser()` - основной XML-парсер
- `_parse_with_regex()` - fallback regex-парсер
- `_collect_test_names(root)` - сбор имён всех тестов
- `_build_parent_map(root)` - построение карты родительских элементов
- `_process_clash_result(...)` - обработка одного clashresult
- `_get_test_name(...)` - определение имени теста
- `_parse_clash_object(element)` - парсинг объекта коллизии
- `_extract_object_id(element)` - извлечение ID из smarttags/objectattribute
- `_extract_pathlink(element)` - извлечение пути из pathlink
- `_resolve_image_path(href)` - преобразование пути к изображению
- `_add_rows(...)` - добавление строк для пары объектов

**Стратегия парсинга:**
1. Пробует XML-парсер (lxml или xml.etree.ElementTree)
2. При ошибке переключается на regex-парсер
3. Создаёт записи для обеих перестановок пары объектов (A→B и B→A)

#### 5. `ResultFilter`
Фильтрация и аннотация результатов.

**Методы:**
- `filter_and_annotate(items)` - фильтрует строки, добавляет категории
- `_process_item(item)` - обработка одной строки

**Логика фильтрации:**
1. Проверяет существование элемента в документе
2. Фильтр по файлу (если `FILTER_BY_FILE = True`)
3. Фильтр по категории (если `FILTER_BY_CATEGORY = True`)
4. Добавляет поля `cat` и `cat_other` к каждой строке

#### 6. `PathHighlighter`
Подсветка категорий в путях элементов.

**Методы:**
- `highlight(path_text, category_name)` - подсвечивает категорию в пути
- `_find_start_after_filename(segments)` - находит позицию после имени файла
- `_wrap_in_badge(text)` - оборачивает текст в HTML span

**Алгоритм:**
1. Пробует подсветить по точному имени категории элемента
2. Если не найдено - ищет по списку категорий документа
3. Начинает поиск после сегмента с именем файла (.rvt, .nwc)
4. Подсвечивает первое совпадение

#### 7. `StatisticsBuilder`
Построение статистики по коллизиям.

**Методы:**
- `build(filtered_groups)` - строит статистику
- `_extract_pair(item)` - извлекает пару ID (упорядоченную)
- `_extract_category_pair(item)` - извлекает пару категорий

**Результат:**
```python
{
    test_name: {
        'pairs': количество_уникальных_пар,
        'catpairs': set((категория1, категория2))
    }
}
```

#### 8. `ResultPrinter`
Вывод результатов в UI pyRevit.

**Методы:**
- `print_report_date(date_value, date_source)` - дата отчёта
- `print_summary(filtered_groups, stats)` - краткая сводка
- `print_total(filtered_groups)` - общее количество
- `print_group(title, rows)` - таблица для группы проверок
- `print_footer()` - подвал с подсказкой
- `_format_image(path, width)` - форматирование изображения

**Формат таблицы:**
| № | Снимок | Название проверки | Пересечение | ID | Путь элемента | Путь второго элемента |

### Вспомогательные структуры

```python
ClashObject = namedtuple('ClashObject', ['element_id', 'path'])

ClashRow = namedtuple('ClashRow', [
    'name', 'image_path', 'element_id', 'other_element_id',
    'path', 'other_path', 'category', 'other_category'
])
```

## Основной процесс работы (main)

```python
1. Выбор XML-файла через диалог
2. Парсинг отчёта (NavisworksReportParser)
3. Показ списка проверок для выбора пользователем
4. Инициализация компонентов:
   - PathHighlighter
   - ResultFilter
   - StatisticsBuilder
   - ResultPrinter
5. Извлечение даты отчёта
6. Фильтрация результатов
7. Построение статистики
8. Вывод:
   - Дата отчёта
   - Краткая сводка
   - Общее количество
   - Таблицы по каждой проверке
   - Подвал с подсказкой
```

## Формат входных данных

### XML-структура Navisworks

```xml
<root>
  <clashtest name="Проверка 1">
    <clashresult name="Коллизия 1" href="image.png">
      <clashobjects>
        <clashobject>
          <smarttags>
            <smarttag>
              <name>Object ID</name>
              <value>123456</value>
            </smarttag>
          </smarttags>
          <pathlink>
            <node>Модель.rvt</node>
            <node>Стены</node>
            <node>Стена-123</node>
          </pathlink>
        </clashobject>
        <clashobject>
          <!-- второй объект -->
        </clashobject>
      </clashobjects>
    </clashresult>
  </clashtest>
</root>
```

## Особенности реализации

### 1. Двойной парсинг
- Основной: XML-парсер (быстрый, надёжный)
- Fallback: regex-парсер (для повреждённых XML)

### 2. Обработка некорректных XML
- Автоопределение кодировки
- Удаление недопустимых символов
- Исправление неэкранированных амперсандов
- Удаление BOM-маркеров

### 3. Интеллектуальная фильтрация
- По имени файла модели в пути
- По категории элемента
- Проверка существования в текущем документе

### 4. Подсветка категорий
- Двухэтапный поиск: точное имя → список категорий
- Игнорирование сегментов до имени файла
- Нормализация для сравнения (удаление спецсимволов, lowercase)

### 5. Кэширование
- Элементы Revit кэшируются для ускорения
- Категории документа собираются один раз при инициализации

### 6. Статистика без дублей
- Пары элементов упорядочиваются (min, max)
- Используется set для исключения повторов
- Пары категорий также дедуплицируются

## Настройка

### Изменить фильтры

```python
# В начале файла
FILTER_BY_FILE = True       # Включить/выключить фильтр по файлу
FILTER_BY_CATEGORY = False  # Включить/выключить фильтр по категории
```

### Изменить стиль подсветки

```python
BADGE_STYLE = u'background:#2f3b4a; color:#fff; padding:1px 6px; border-radius:3px; font-weight:600;'
```

### Добавить атрибуты для поиска ID

```python
OBJECT_ID_NAMES = frozenset([
    'объект id', 'object id', 'object 1 id',
    'object 2 id', 'id объекта',
    'новый атрибут'  # Добавить сюда
])
```

## Возможные улучшения

1. **Экспорт результатов** - сохранение в Excel/CSV
2. **Группировка по уровням** - дополнительная группировка результатов
3. **Фильтр по датам** - показывать только новые коллизии
4. **Изоляция элементов** - выделение всех элементов группы одним кликом
5. **История проверок** - сравнение с предыдущими отчётами
6. **Настройки через UI** - диалог настроек вместо констант в коде

## Зависимости

- `pyRevit` - фреймворк для скриптов Revit
- `Autodesk.Revit.DB` - API Revit
- `lxml` (опционально) - быстрый XML-парсер
- `xml.etree.ElementTree` (встроенный) - fallback парсер

## Производительность

- **Кэширование элементов** - O(1) после первого обращения
- **Regex компиляция** - один раз при импорте
- **Фильтрация** - ленивая, только для выбранных проверок
- **Память** - минимальная, используются генераторы где возможно

## Обработка ошибок

1. **XML не читается** → fallback на regex-парсер
2. **Элемент не найден** → исключается из результатов
3. **Некорректная кодировка** → перебор кодировок + ignore
4. **Отсутствует изображение** → показывается "—"
5. **Нет даты в XML** → берётся дата изменения файла

## Автор

- vlad / you
- Дата последнего рефакторинга: 2025-12-26
